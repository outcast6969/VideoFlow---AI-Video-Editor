<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoFlow - AI Video Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .team-badge {
            display: inline-block;
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            letter-spacing: 0.5px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateY(-2px);
        }

        .upload-section svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .upload-section h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-section p {
            color: #666;
            font-size: 16px;
        }

        input[type="file"] {
            display: none;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .option-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .option-card h4 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .option-card p {
            font-size: 14px;
            opacity: 0.8;
        }

        .custom-prompt {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .custom-prompt:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-process {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-process:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-process:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .video-preview {
            margin-top: 30px;
            display: none;
        }

        .video-preview video {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-radius: 15px;
            text-align: center;
        }

        .result-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .download-btn {
            display: inline-block;
            padding: 15px 40px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .file-info {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            text-align: center;
        }

        .file-info span {
            font-weight: 600;
            color: #667eea;
        }

        .ai-analysis {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 8px;
        }

        .ai-analysis h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .ai-analysis p {
            color: #856404;
            line-height: 1.6;
        }

        canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>VideoFlow</h1>
            <p>–ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç–µ –ª—é–±–æ–µ –≤–∏–¥–µ–æ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π –∑–∞ –º–∏–Ω—É—Ç—É</p>
            <div class="team-badge">by Legion of Outcasts</div>
        </header>

        <div class="main-card">
            <div class="upload-section" id="uploadArea">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ –≤–∏–¥–µ–æ</h3>
                <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: MP4, MOV, AVI, WebM</p>
                <input type="file" id="videoInput" accept="video/*">
            </div>

            <div class="file-info" id="fileInfo">
                <p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ: <span id="fileName"></span></p>
            </div>

            <div class="video-preview" id="videoPreview">
                <video id="previewVideo" controls></video>
            </div>

            <h3 style="margin: 30px 0 20px 0; color: #333;">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
            
            <div class="options-grid" id="optionsGrid">
                <div class="option-card" data-style="viral">
                    <h4>üî• –í–∏—Ä—É—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h4>
                    <p>–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –∏ —è—Ä–∫–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è</p>
                </div>
                <div class="option-card" data-style="aesthetic">
                    <h4>‚ú® –≠—Å—Ç–µ—Ç–∏—á–Ω—ã–π</h4>
                    <p>–ú—è–≥–∫–∞—è —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∏ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–Ω–∞</p>
                </div>
                <div class="option-card" data-style="cinematic">
                    <h4>üé¨ –ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω—ã–π</h4>
                    <p>–¢–µ–º–Ω—ã–µ —Ç–æ–Ω–∞, –≤—ã—Å–æ–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç, –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞</p>
                </div>
                <div class="option-card" data-style="bright">
                    <h4>‚òÄÔ∏è –Ø—Ä–∫–∏–π –∏ —á–µ—Ç–∫–∏–π</h4>
                    <p>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å –∏ —á–µ—Ç–∫–æ—Å—Ç—å –¥–ª—è –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</p>
                </div>
            </div>

            <textarea class="custom-prompt" id="customPrompt" placeholder="–ò–ª–∏ –æ–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–¥–µ–ª–∞–π –±–æ–ª–µ–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–º –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º', '–î–æ–±–∞–≤—å —Ç–µ–ø–ª—ã–µ —Ç–æ–Ω–∞')"></textarea>

            <button class="btn-process" id="processBtn" disabled>
                –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∏–¥–µ–æ —Å AI
            </button>

            <div class="ai-analysis" id="aiAnalysis">
                <h4>ü§ñ AI –∞–Ω–∞–ª–∏–∑ –∏ –ø–ª–∞–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h4>
                <p id="aiAnalysisText"></p>
            </div>

            <div class="progress-section" id="progressSection">
                <div class="spinner"></div>
                <p id="progressText">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–µ–æ...</p>
            </div>

            <div class="result-section" id="resultSection">
                <h3>‚ú® –í–∞—à–µ –≤–∏–¥–µ–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ!</h3>
                <video id="resultVideo" controls style="max-width: 100%; border-radius: 10px; margin: 20px 0;"></video>
                <a href="#" class="download-btn" id="downloadBtn">–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ</a>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        let selectedFile = null;
        let selectedStyle = null;
        let videoElement = null;

        const uploadArea = document.getElementById('uploadArea');
        const videoInput = document.getElementById('videoInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const videoPreview = document.getElementById('videoPreview');
        const previewVideo = document.getElementById('previewVideo');
        const optionsGrid = document.getElementById('optionsGrid');
        const processBtn = document.getElementById('processBtn');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const resultSection = document.getElementById('resultSection');
        const resultVideo = document.getElementById('resultVideo');
        const downloadBtn = document.getElementById('downloadBtn');
        const customPrompt = document.getElementById('customPrompt');
        const aiAnalysis = document.getElementById('aiAnalysis');
        const aiAnalysisText = document.getElementById('aiAnalysisText');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        uploadArea.addEventListener('click', () => videoInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#764ba2';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#667eea';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#667eea';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        videoInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('video/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            
            const url = URL.createObjectURL(file);
            previewVideo.src = url;
            videoPreview.style.display = 'block';
            
            updateProcessButton();
        }

        optionsGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.option-card');
            if (card) {
                document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedStyle = card.dataset.style;
                updateProcessButton();
            }
        });

        customPrompt.addEventListener('input', updateProcessButton);

        function updateProcessButton() {
            processBtn.disabled = !selectedFile || (!selectedStyle && !customPrompt.value.trim());
        }

        async function getAIInstructions(style, customText) {
            const styleDescriptions = {
                viral: "—É–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Ü–≤–µ—Ç–æ–≤ –Ω–∞ 40%, –ø–æ–≤—ã—Å–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç –Ω–∞ 30%, —Å–¥–µ–ª–∞—Ç—å —è—Ä–∫–æ—Å—Ç—å –Ω–∞ 20% –≤—ã—à–µ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è",
                aesthetic: "–ø—Ä–∏–º–µ–Ω–∏—Ç—å –º—è–≥–∫—É—é –ø–∞—Å—Ç–µ–ª—å–Ω—É—é —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—é, —Å–Ω–∏–∑–∏—Ç—å –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 10%, –¥–æ–±–∞–≤–∏—Ç—å –ª–µ–≥–∫–æ–µ —Ç–µ–ø–ª–æ–µ —Ç–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
                cinematic: "–ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π look —Å –ø–æ–≤—ã—à–µ–Ω–∏–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –Ω–∞ 50%, –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ–º —Ç–µ–Ω–µ–π –Ω–∞ 20%, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ö–æ–ª–æ–¥–Ω—ã—Ö —Ç–æ–Ω–æ–≤ –≤ —Ç–µ–Ω–∏ –∏ —Ç–µ–ø–ª—ã—Ö –≤ —Å–≤–µ—Ç–∞—Ö",
                bright: "–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–≤—ã—Å–∏—Ç—å —è—Ä–∫–æ—Å—Ç—å –Ω–∞ 35%, —É–≤–µ–ª–∏—á–∏—Ç—å —á–µ—Ç–∫–æ—Å—Ç—å –∏ —Ä–µ–∑–∫–æ—Å—Ç—å, —Å–¥–µ–ª–∞—Ç—å —Ü–≤–µ—Ç–∞ –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º–∏ –Ω–∞ 25%"
            };

            const prompt = customText || styleDescriptions[style];

            try {
                progressText.textContent = 'AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∏–¥–µ–æ –∏ —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏...';
                
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∏–¥–µ–æ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç: "${prompt}". 
                            
–°–æ–∑–¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "brightness": —á–∏—Å–ª–æ –æ—Ç -50 –¥–æ 50 (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏),
  "contrast": —á–∏—Å–ª–æ –æ—Ç -50 –¥–æ 50 (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞),
  "saturation": —á–∏—Å–ª–æ –æ—Ç -50 –¥–æ 50 (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏),
  "description": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ"
}

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`
                        }]
                    })
                });

                const data = await response.json();
                let text = data.content[0].text.trim();
                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                
                const instructions = JSON.parse(text);
                return instructions;
            } catch (error) {
                console.error('AI error:', error);
                return {
                    brightness: style === 'bright' ? 25 : style === 'cinematic' ? -15 : 10,
                    contrast: style === 'cinematic' ? 35 : style === 'viral' ? 20 : 10,
                    saturation: style === 'aesthetic' ? -10 : style === 'viral' ? 30 : 15,
                    description: "–ü—Ä–∏–º–µ–Ω—è—é –±–∞–∑–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è"
                };
            }
        }

        function applyVideoEffects(video, instructions) {
            return new Promise((resolve) => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const frames = [];
                const frameRate = 30;
                const duration = Math.min(video.duration, 30);
                const totalFrames = Math.floor(duration * frameRate);
                let currentFrame = 0;

                video.currentTime = 0;

                const captureFrame = () => {
                    if (currentFrame >= totalFrames) {
                        createVideoFromFrames(frames, frameRate).then(resolve);
                        return;
                    }

                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    const brightnessFactor = 1 + (instructions.brightness / 100);
                    const contrastFactor = 1 + (instructions.contrast / 100);
                    const saturationFactor = 1 + (instructions.saturation / 100);

                    for (let i = 0; i < data.length; i += 4) {
                        let r = data[i];
                        let g = data[i + 1];
                        let b = data[i + 2];

                        r = ((r - 128) * contrastFactor + 128) * brightnessFactor;
                        g = ((g - 128) * contrastFactor + 128) * brightnessFactor;
                        b = ((b - 128) * contrastFactor + 128) * brightnessFactor;

                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        r = gray + (r - gray) * saturationFactor;
                        g = gray + (g - gray) * saturationFactor;
                        b = gray + (b - gray) * saturationFactor;

                        data[i] = Math.max(0, Math.min(255, r));
                        data[i + 1] = Math.max(0, Math.min(255, g));
                        data[i + 2] = Math.max(0, Math.min(255, b));
                    }

                    ctx.putImageData(imageData, 0, 0);
                    frames.push(canvas.toDataURL('image/jpeg', 0.8));

                    currentFrame++;
                    const progress = Math.round((currentFrame / totalFrames) * 100);
                    progressText.textContent = `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–¥—Ä—ã: ${progress}%`;
                    
                    video.currentTime = (currentFrame / frameRate);
                };

                video.addEventListener('seeked', captureFrame);
                video.currentTime = 0;
            });
        }

        async function createVideoFromFrames(frames, frameRate) {
            const stream = canvas.captureStream(frameRate);
            const mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 5000000
            });

            const chunks = [];
            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

            return new Promise((resolve) => {
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    resolve(URL.createObjectURL(blob));
                };

                mediaRecorder.start();

                let frameIndex = 0;
                const drawFrame = () => {
                    if (frameIndex >= frames.length) {
                        mediaRecorder.stop();
                        return;
                    }

                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0);
                        frameIndex++;
                        setTimeout(drawFrame, 1000 / frameRate);
                    };
                    img.src = frames[frameIndex];
                };

                drawFrame();
            });
        }

        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            processBtn.disabled = true;
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            aiAnalysis.style.display = 'none';

            try {
                const instructions = await getAIInstructions(
                    selectedStyle, 
                    customPrompt.value.trim()
                );

                aiAnalysis.style.display = 'block';
                aiAnalysisText.textContent = instructions.description;

                progressText.textContent = '–ü—Ä–∏–º–µ–Ω—è–µ–º AI-–æ–±—Ä–∞–±–æ—Ç–∫—É –∫ –≤–∏–¥–µ–æ...';

                const processedUrl = await applyVideoEffects(previewVideo, instructions);
                
                resultVideo.src = processedUrl;
                downloadBtn.href = processedUrl;
                downloadBtn.download = `videoflow_processed_${Date.now()}.webm`;
                
                progressSection.style.display = 'none';
                resultSection.style.display = 'block';
                
                resultSection.scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                console.error('Processing error:', err);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∏–¥–µ–æ: ' + err.message);
                progressSection.style.display = 'none';
            } finally {
                processBtn.disabled = false;
            }
        });
    </script>
</body>
</html>